# Windows API 정복 1권 (김상형 저) 정리 4편

**저작권 문제 발생 시 알려주시면 바로 처리하도록 하겠습니다. 도서를 읽고 정리한 것이니 양해 부탁드립니다.**

## 메시지 루프

Windows를 메시지 구동 시스템(Message Driven System)이라고 한다. 이 점이 DOS와 가장 뚜렷한 대비를 이룬다.  
프로그램의 실행 순서가 명확하게 정해져 있지 않으며 상황에 따라 실행 순서가 달라진다. 그 상황은 메시지가 발생했는가를 의미한다.  
  
메시지 : 사용자나 시스템의 내부적인 동작에 의해 발생된 일체의 변화에 대한 정보  
[ EX ]  
1 마우스 클릭  
2 키보드 입력  
3 윈도우 최소화  
  
메세지를 받은 프로그램은 메시지가 어떤 정보를 담고 있는가를 분석하여 동작을 결정함.  
즉, 순서를 따르지 않고 주어진 메시지에 대한 반응을 정의하는 방식으로 프로그램이 실행된다.  
  
Windows 프로그램에서 메시지를 처리하는 부분을 메시지 루프(message Loop)라고 한다.  
보통 WinMain 함수 끝에 다음과 같은 형식으로 존재한다.  
메인 윈도우를 만든 직후 WinMain은 메시지 루프를 실행한다.  
  
    while(GetMessage(&Message, NULL, 0, 0))
    {
        TranslateMessage(&Message);
        DispatchMessage(&Message);
    }

각 함수가 어떤 동작을 하는지 알아보자.

    BOOL GetMessage(LPMSG lpMsg, HWND hWnd, UINT wMsgFilterMin, UINT wMsgFilterMax);

이 함수는 메시지 큐에서 메시지를 읽어들인다.  

메시지 큐(Message Queue) : 시스템이나 사용자로부터 발생된 메시지가 잠시 대기하는 일종의 메시지 임시 저장 영역  
  
읽어들인 메시지는 첫 번째 인수가 지정하는 MSG 구조체에 저장된다.  
이 함수는 읽어들인 메시지가 프로그램을 종료하라는 WM_QUIT일 경우 FALSE를 리턴하며 그 외의 메시지이면 TRUE를 리턴한다.  
  
WM_QUIT 메시지는 프로그램이 종료될 때 읽혀진다.  
  
    BOOL TranslateMessage(CONST MSG* lpMsg);

이 함수는 키보드 입력 메시지를 가공하여 프로그램에서 쉽게 쓸 수 있도록 한다.  
Windows는 키보드의 어떤 키가 눌러지거나 떨어졌을 때 키보드 메시지를 발생시키는데 TranslateMessage 함수는 키보드의 눌림(WM_KEYDOWN) 메시지가 발생할 때 문자가 입력되었다는 메시지(WM_CHAR)를 만드는 역할을 한다.  
  
    LONG DispatchMessage(CONST MSG* lpmsg);

이 함수는 메시지 큐에서 꺼낸 메시지를 윈도우의 메시지 처리 함수(WndProc)로 전달한다.  
이 함수에 의해 메시지가 윈도우로 전달되며 윈도우 프로시저에서는 전달된 메시지를 점검하여 다음 동작을 결정한다.  
  
  
메시지 루프가 하는 일이란 메시지 큐에서 메시지를 꺼내 메시지 처리 함수로 보내는 것뿐이다.  
실제 메시지 처리는 별도의 메시지 처리 함수(WndProc)에서 수행한다.  
  
메시지 루프의 세 함수는 공통적으로 MSG라는 구조체를 사용한다.  
이 구조체는 메시지에 대한 정보를 정의한다.  
  
    typedef struct tagMSG
    {
        HWND hwnd;
        UINT message;
        WPARAM wParam;
        LPARAM lParam;
        DWORD time;
        POINT pt;
    } MSG;

각 멤버의 의미는 다음과 같다.  
  
멤버 | 의미
-----|------
hwnd | 메시지를 받을 윈도우 핸들
message | 어떤 종류의 메시지인가를 나타낸다. 가장 중요한 값이다.
wParam | 전달된 메시지에 대한 부가적인 정보를 가진다. 어떤 의미를 가지는가는 메시지별로 다르다. 32비트 값이다.
lParam | 전달된 메시지에 대한 부가적인 정보를 가진다. 어떤 의미를 가지는가는 메시지별로 다르다. 32비트 값이다.
time | 메시지가 발생한 시간이다.
pt | 메시지가 발생했을 때의 마우스 위치이다.

message 멤버를 읽음으로써 메시지의 종류를 파악하며 message값에 따라 프로그램의 반응이 달라진다.  
GetMessage 함수는 읽은 메시지를 MSG형의 구조체에 대입하며 이 구조체는 DispatchMessage 함수에 의해 응용 프로그램의 메시지 처리 함수(WndProc)로 전달된다.  
  
메시지는 실제로 하나의 정수값으로 표현되는데 종류가 무척 많아 메시지 번호를 일일이 암기하여 사용할 수 없으므로 <windows.h>에 메시지별로 매크로 상수를 정의해 두었으며 접두어 WM_으로 시작된다.  
가장 자주 사용되는 메시지를 몇 개만 보인다.  
  
메시지 | 의미
-------|-----
WM_QUIT | 프로그램을 끝낼 때 발생하는 메시지
WM_LBUTTONDOWN | 마우스의 좌측 버튼을 누를 경우 발생
WM_KEYDOWN | 키보드의 키를 누름
WM_CHAR | 키보드로부터 문자가 입력될 때 발생
WM_PAINT | 화면을 다시 그려야 할 때 발생
WM_CREATE | 윈도우가 처음 만들어질 때 발생
WM_DESTORY | 윈도우가 메모리에서 파괴될 때 발생

메시지 루프가 종료되면 프로그램은 마지막으로 Message.wParam을 리턴하고 종료함  
이 값은 WM_QUIT 메시지로부터 전달된 탈출 코드(exit code)이며 이 프로그램을 실행시킨 운영체제로 리턴된다.  
사용되는 경우가 거의 없다.