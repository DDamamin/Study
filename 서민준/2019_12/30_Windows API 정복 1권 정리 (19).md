# Windows API 정복 1권(김상형 저) 정리 19편

**저작권 문제시 연락주시면 바로 처리하도록 하겠습니다. 학생으로서 독서를 읽은 뒤 정리하면서 학습하는 용도로만 사용하였습니다. 양해 부탁드립니다.**

## TranslateMessage

키보드에서 A키를 눌렀다가 뗐다고 해 보자.  
이 때 발생하는 메시지는 순서대로 WM_KEYDOWN, WM_CHAR, WM_KEYUP 세 가지이다.  
이 중 WM_CHAR 메시지는 사용자에 의해 발생하는 메시지가 아니다.  
키보드로부터 전달되는 메시지는 키를 누를 때 WM_KEYDOWN, 키를 뗄 때 WM_KEYUP 두 가지 뿐이다.  
그럼 WM_CHAR 메시지는 어디서 발생할까?  
이 메시지는 WM_KEYDOWN에 의해 추가로 발생하는 메시지이며 메시지 루프에서 인위적으로 생성된다.  
메시지 루프를 다시 보자.  
  
    while (GetMessage(&Message, NULL, 0, 0))
    {
        TranslateMessage(&Message);
        DispatchMessage(&Message);
    }

GetMessage는 메시지 큐에서 메시지를 꺼낸 후 이 메시지를 TranslateMessage 함수로 넘긴다.  
TranslateMessage 함수는 전달된 메시지가 WM_KEYDOWN인지와 눌러진 키가 문자키인지 검사해 보고 조건이 맞을 경우 WM_CHAR 메시지를 추가로 발생시킨다.  
물론 문자 입력이 아닐 경우는 아무 일도 하지 않으며 이 메시지는 DispatchMessage 함수에 의해 WndProc으로 보내진다.  
만약 메시지 루프에서 TranslateMessage 함수를 빼 버리면 WM_CHAR 메시지는 절대로 WndProc으로 전달되지 않을 것이다.  
  
메시지 루프의 TranslateMessage 함수는 오로지 키보드로부터 문자키 입력 메시지인 WM_CHAR를 만들어내기 위해 존재한다.  
만약 WM_CHAR 메시지를 전혀 받을 필요가 없는 프로그램이라면 메시지 루프에서 이 함수는 생략해도 상관없다.  
그러나 있어도 크게 손해 볼 것은 없으므로 일반적인 메시지 루프에 이 함수가 포함되어 있는 것이다.  
  
TranslateMessage가 하는 일이 무척 단순한 것 같지만 내부적으로는 꽤 많은 계산을 한다.  
일단 어떤 키가 문자키인지는 키보드 레이아웃에 따라 달라지기 때문에 입력된 키가 과연 문자키인지는 키보드 레이아웃에 따라 달라지기 때문에 입력된 키가 과연 문자키인지부터 검사해야 한다.  
A키가 반드시 'A'문자를 입력해야 한다는 강제 규정은 없기 때문이다.  
국가에 따라서는 문자키에 다른 용도를 정해 쓸 수도 있고 독일어나 러시아어처럼 알파벳 구조가 영어와 다른 나라는 문자키가 더 많을 수도 있고 적을 수도 있다.  
  
어떤 키가 문자키인지는 키보드 디바이스 드라이버에 의해 결정된다.  
일단 문자키가 입력된 후에도 Shift키와 Caps Lock키의 상태, 또는 영어에는 없는 입력 상태(히라가나, 가타가나, 전자, 반자 등)를 종합 판단해 본 후 최종 입력된 문자를 선택해 WM_CHAR 메시지를 날린다.  
한글 Windows에서는 A키가 눌러졌을 때 입력될 문자만 해도 4가지나 된다.  
  
사실 이런 처리는 단순히 키보드의 상태를 조사해서 최종 문자를 선택하는 간단한 조건식이기 때문에 우리가 직접 코드를 작성해도 그다지 어렵지는 않을 것이다.  
그러나 솔직히 굉장히 귀찮은 일임에는 분명하다.  
이 함수가 이렇게 복잡한 문자 변환을 알아서 하기 때문에 우리는 편하게 WM_CHAR 메시지를 받을 수 있으며 wParam을 통해 어떤 문자가 입력되었는지만 조사하면 되는 것이다.  
  
이상 키보드 메시지들에 대해 알아보았는데 여기서 알아본 키보드 메시지외에 WM_SYSKEYDOWN, WM_SYSKEYUP, WM_SYSCHAR 등의 시스템 키보드 메시지들도 있다.  
앞에 SYS가 붙는 메시지는 모두 Alt 키와 함께 눌러지는 키보드 메시지들이며 이 메시지들은 시스템의 내부적인 용도로 사용되므로 응용 프로그램에서 처리하는 경우는 별로 없다.  
그러나 만약 꼭 이 메시지를 받아 처리하겠다면 가능하기는 하지만 이때 메시지를 처리한 후 그냥 리턴해서는 안 되며 반드시 DefWindowProc으로 보내 줘야 한다.  
그렇지 않으면, Alt 키와 함께 동작하는 키보드 조합이 먹통이 되어 버린다. 단축키는 물론이고 Alt + Esc, Alt + Tab같은 작업 전환 키까지 불능이 되어 버릴 것이다.  
  
이 외에 WM_DEADCHAR, WM_SYSDEADCHAR라는 메시지도 있는데 유럽의 악센트 문자, 움라우트 문자 입력을 위한 메시지이다.  
움라우트 문자가 먼저 오고 알파벳 문자가 오면 이 둘을 합쳐 움라우트 문자를 만들어 낸다.  
미국이나 한국에는 이런 문자가 없으므로 한글이나 영문을 입력할 때는 이 메시지가 전달되지 않는다.  
즉, 한국 프로그래머들은 유럽으로 수출하는 소프트웨어를 만들지 않는 한 전혀 신경쓸 필요가 없는 메시지이다.